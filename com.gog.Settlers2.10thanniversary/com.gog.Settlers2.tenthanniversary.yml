app-id: com.gog.Settlers2.tenthanniversary
branch: alfa

runtime: org.winepak.Platform/i386
runtime-version: 3.0
sdk: org.winepak.Sdk/i386

command: start

tags:
- proprietary

finish-args:
- --socket=x11
- --share=ipc
- --socket=pulseaudio
- --device=dri
- --allow=multiarch
- --device=all
- --share=network
- --env=WINEPREFIX=/var/data/win32
- --env=WINEARCH=win32
- --env=WINEDEBUG=-all
- --filesystem=/run/media:ro
- --filesystem=/mnt:ro
- --filesystem=home
- --persist=S2

build-options:
  cflags: -O2 -pipe -fstack-protector-strong -fno-plt -frecord-gcc-switches -D_FORTIFY_SOURCE=1 -msse -msse2 -mfpmath=sse
  cxxflags: -O2 -pipe -fstack-protector-strong -fno-plt -frecord-gcc-switches -D_FORTIFY_SOURCE=1 -msse -msse2 -mfpmath=sse
  ldflags: -fstack-protector-strong -Wl,-z,relro,-z,now
  prefix: "/app"
  libdir: "/app/lib"

modules:
- "flatpak_wine_infrastructure_script/wine_infrastructure.yml"

- name: setup
  buildsystem: simple
  build-commands:
  - mkdir -p /app/bin
  - install -Dm555 start /app/bin
  - install -Dm555 installer /app/bin

  sources:
  - type: script
    dest-filename: installer
    commands:
    - mkdir -p $WINEPREFIX
    - wineboot
    - winetricks d3dx9 | tee /tmp/dotnet.log | zenity --progress --pulsate --auto-close --auto-kill --no-cancel --text="Installing directx 9."
    - wine reg add 'HKEY_CURRENT_USER\Software\Wine\X11 Driver' /v GrabFullScreen /d N /f
    -
    - zenity --info --title="Settlers 2" --text "Please install in the default location"
    - FILE="$(zenity --file-selection --title='Select a gogs settlers 2 10th anniversary installer')"
    - wine "$FILE"
    - exit 0

  - type: script
    dest-filename: start
    commands:
    - #install
    - source setup_infrastructure.sh "${WINEPREFIX}/drive_c/GOG Games/The Settlers II - 10th Anniversary/Settlers2Serial.exe" "installer"
    -
    - echo "launching Settlers 2"
    - cd "/var/data/win32/drive_c/GOG Games/The Settlers II - 10th Anniversary"
    - wine "C:/GOG Games/The Settlers II - 10th Anniversary/bin/S2DNG.exe" "$@"

- name: resources
  buildsystem: simple
  build-commands:
  - install -Dm644 com.gog.Settlers2.tenthanniversary.png /app/share/icons/hicolor/128x128/apps/com.gog.Settlers2.tenthanniversary.png
  - install -Dm644 com.gog.Settlers2.tenthanniversary.appdata.xml /app/share/appdata/com.gog.Settlers2.tenthanniversary.appdata.xml
  - install -Dm644 com.gog.Settlers2.tenthanniversary.desktop /app/share/applications/com.gog.Settlers2.tenthanniversary.desktop
  sources:
  - type: file
    path: com.gog.Settlers2.tenthanniversary.appdata.xml
  - type: file
    path: com.gog.Settlers2.tenthanniversary.desktop
  - type: file
    path: com.gog.Settlers2.tenthanniversary.png
