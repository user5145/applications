app-id: com.blizzard.Diablo2
branch: alfa

runtime: org.winepak.Platform/i386
runtime-version: 3.0
sdk: org.winepak.Sdk/i386

command: start

tags:
- proprietary

finish-args:
  - --socket=x11
  - --share=ipc
  - --socket=pulseaudio
  - --device=dri
  - --allow=multiarch
  - --device=all
  - --share=network
  - --persist=xdg-desktop
  - --env=WINEPREFIX=/var/data/win32
  - --env=WINEARCH=win32
  - --env=WINEDEBUG=-all

add-extensions:
  com.blizzard.Diablo2.LordofDestruction:
    directory: extensions/lod
    version: alfa
    subdirectories: false
    autodelete: false
    no-autodownload: true

modules:
  - name: diablo
    buildsystem: simple
    build-commands:
      - mkdir -p /app/bin
      - install -Dm766 Downloader_Diablo2_enUS.exe /app/bin
      

    sources:
      - type: file
        path: Downloader_Diablo2_enUS.exe


  - name: setup
    buildsystem: simple
    build-commands:
      - mkdir -p /app/bin
      - install -Dm766 start /app/bin
      - install -Dm766 installer /app/bin
      - install -Dm766 tweaks /app/bin
      - install -Dm644 glide3x.dll /app/bin
      - install -Dm644 glide-init.exe /app/bin

    sources:
      - type: archive
        url: http://www.svenswrapper.de/gl32ogl14e.zip
        sha256: cd9d3688b35decf0fbd4c97d584577a7628e74aeac808f0a0a52fbcfdd1818c6

      - type: script
        dest-filename: installer
        commands:
          - mkdir -p $WINEPREFIX
          - wineboot
          -
          - tweaks
          - 
          - wine reg add 'HKEY_CURRENT_USER\Software\Wine\X11 Driver' /v UseXRandR /d N /f
          -
          - install -d "/var/data/win32/drive_c/Program Files/Diablo II/"
          - install /app/bin/glide3x.dll "/var/data/win32/drive_c/Program Files/Diablo II/"
          - install /app/bin/glide-init.exe "/var/data/win32/drive_c/Program Files/Diablo II/"
          - wine /app/bin/Downloader_Diablo2_enUS.exe "$@"

      - type: script
        dest-filename: tweaks
        commands:
          - #tweaks
          - #XRandr breaks movies when in fullscreen
          - wine reg add 'HKEY_CURRENT_USER\Software\Wine\X11 Driver' /v UseXRandR /d N /f

      - type: script
        dest-filename: start
        commands:
          - #install diablo2
          - if ! [ -e "${WINEPREFIX}/drive_c/Program Files/Diablo II/Diablo II.exe" ] ; then
          - '    echo "installing Diablo 2"'
          - '    source /app/bin/installer'
          - '    if [[ $? != 0 ]] ; then'
          - '        echo "Installation failed, abort."'
          - '        exit 1'
          - '    fi'
          - 'exit 0'
          -
          - #install diablo2 lod
          - elif [ -e /app/extensions/lod/bin/installer ] && [ ! -e "${WINEPREFIX}/drive_c/Program Files/Diablo II/Diablo II LOD Install Log.html" ] ; then
          - '         echo "installing Diablo 2 lod"'
          - '         /app/extensions/lod/bin/installer "$@"'
          - '         if [[ $? != 0 ]] ; then'
          - '              echo "Installation failed, abort."'
          - '              exit 1'
          - '         fi'
          - 'exit 0'
          - fi
          -
          - #launch
          - # remove old files
          - 'for f in "${WINEPREFIX}/drive_c/users/$USER/Desktop/D2-1.14b-Installer-*" ; do'
          - '    rm -R $f'
          - 'done'
          - 'for f in "${WINEPREFIX}/drive_c/users/$USER/Desktop/D2LOD-1.14b-Installer-*" ; do'
          - '    rm -R $f'
          - 'done'
          -
          - 'echo "launching Diablo 2"'
          - 'cd "/var/data/win32/drive_c/Program Files/Diablo II/"'
          - 'wine "C:/Program Files/Diablo II/glide-init.exe"'
          - 'wine "C:/Program Files/Diablo II/Diablo II.exe" -w $@'

  - name: resources
    buildsystem: simple
    build-commands:
      - install -Dm644 com.blizzard.Diablo2.png /app/share/icons/hicolor/128x128/apps/com.blizzard.Diablo2.png
      - install -Dm644 com.blizzard.Diablo2.appdata.xml /app/share/appdata/com.blizzard.Diablo2.appdata.xml
      - install -Dm644 com.blizzard.Diablo2.desktop /app/share/applications/com.blizzard.Diablo2.desktop

    sources:
      - type: file
        path: com.blizzard.Diablo2.png

      - type: file
        path: com.blizzard.Diablo2.appdata.xml

      - type: file
        path: com.blizzard.Diablo2.desktop

    post-install:
    - mkdir -p /app/extensions/lod
