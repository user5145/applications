build-extension: true

id: com.gog.HeroesofMightandMagic.hd
branch: alfa

runtime: com.gog.HeroesofMightandMagic//alfa
sdk: org.winepak.Sdk/i386/3.0

separate-locales: false
appstream-compose: false

modules:
  - name: hd
    buildsystem: simple
    build-commands:      
      - install -d ${FLATPAK_DEST}/bin
      - install -Dm555 installer ${FLATPAK_DEST}/bin
      - install -Dm555 starter ${FLATPAK_DEST}/bin

    sources:
      - type: extra-data
        url: http://ih875403.vds.myihor.ru/HoMM3_HD_Latest_setup.exe
        sha256: e78046e7333b4a0514f4273423b1f9abe00b2ab0b6d35e9de16941d7729a12f3
        filename: hd_setup.exe
        size: 13238940

      - type: script
        dest-filename: installer
        commands:
          - # check if game has been launched (by checking folder's files)
          - if [[ ! -e "${WINEPREFIX}/drive_c/GOG Games/HoMM 3 Complete/HD3_Launcher.exe" ]] || [[ $(dirname $0)/../extra/hd_setup.exe -nt "${WINEPREFIX}/drive_c/GOG Games/HoMM 3 Complete/hd_setup.exe" ]] ; then
          -     echo "installing hd mod."
          -     install -d "${WINEPREFIX}/drive_c/GOG Games/HoMM 3 Complete/"
          -     cp -rf $(dirname $0)/../extra/hd_setup.exe "${WINEPREFIX}/drive_c/GOG Games/HoMM 3 Complete/"
          -     cd "${WINEPREFIX}/drive_c/GOG Games/HoMM 3 Complete/"
          -     
          -     # 2019.03 hd mod want homm3 to be in Program files
          -     ln -sf "${WINEPREFIX}/drive_c/GOG Games/HoMM 3 Complete/" "${WINEPREFIX}/drive_c\Program Files\Heroes of Might and Magic III"
          -     wine "${WINEPREFIX}/drive_c/GOG Games/HoMM 3 Complete/hd_setup.exe"
          -     # return 2 when it's not installed, if installed close. It helps launch the game for the first time
          -     if [[ $? != 2 ]] ; then
          -         exit 255
          -     fi
          - fi

      - type: script
        dest-filename: starter
        commands:
          - if [[ -e "${WINEPREFIX}/drive_c/GOG Games/HoMM 3 Complete/HD3_Launcher.exe" ]]; then
          -      echo "hd mod enabled"
          -      cd "${WINEPREFIX}/drive_c/GOG Games/HoMM 3 Complete/"
          -      wine "C:/GOG Games/HoMM 3 Complete/HD3_Launcher.exe"
          -      exit 0
          - fi

  - name: metainfo
    buildsystem: simple
    build-commands:
      - install -Dm644 --target-directory=${FLATPAK_DEST}/share/metainfo com.gog.HeroesofMightandMagic.hd.metainfo.xml
    sources:
      - type: file
        path: com.gog.HeroesofMightandMagic.hd.metainfo.xml
