app-id: sh.ppy.Osu
branch: alfa

runtime: org.winepak.Platform
runtime-version: 3.0
sdk: org.winepak.Sdk

command: start

#workaround, wine 3.0.1 doesn't launch osu properly
add-extensions:
  org.winepak.Platform.Compat32:
    directory: lib/32bit
    version: 3.0
    add-ld-path: lib
    no-autodownload: false

  org.winepak.Platform.Wine.Compat32:
    directory: lib/wine-32bit
    version: 3.8-staging
    add-ld-path: lib
    no-autodownload: false

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  - --allow=multiarch
  - --device=all
  - --share=network
  - --env=WINEPREFIX=/var/data/win32
  - --env=WINEARCH=win32
  - --env=WINEDEBUG=-all


modules:
  - name: setup-compat32
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib/32bit
      - ln -s /app/lib/32bit/lib/ld-linux.so.2 /app/lib/ld-linux.so.2

  - name: setup-wine-compat32
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib/wine-32bit

  - name: osu
    buildsystem: simple
    build-commands:
      - install -d /app/bin
      - install osu!install.exe /app/bin

    sources:
      - type: file
        url: https://m1.ppy.sh/r/osu!install.exe
        sha256: db0b45baa5aef5ac2870802d26b1fcb0faf28d269dfdf3ba3a8392dabb4d377f


  - name: scripts
    buildsystem: simple
    build-commands:
      - install -d /app/bin
      - install start /app/bin
      - install installer /app/bin

    sources:
      - type: script
        dest-filename: installer
        commands:
          - mkdir -p /var/data/win32
          - wineboot
          - winetricks dotnet40
          - winetricks gdiplus
          - 
          - install -Dm644 /app/discord-rpc.dll "${WINEPREFIX}/drive_c/users/$USER/Local Settings/Application Data/osu!/discord-rpc.dll"
          - wine /app/bin/osu!install.exe "$@"

      - type: script
        dest-filename: start
        commands:
          - if ! [ -e "${WINEPREFIX}/drive_c/users/$USER/Local Settings/Application Data/osu!/osu!.exe" ] ; then
          - '    source /app/bin/installer'
          - '    if [[ $? != 0 ]] ; then'
          - '        echo "Installation failed, abort."'
          - '        exit 1'
          - '    fi'
          - else
          -      wine "C:/users/$USER/Local Settings/Application Data/osu!/osu!.exe"
          - fi


  - name: resources
    buildsystem: simple
    build-commands:
      - install -Dm644 sh.ppy.Osu.svg /app/share/icons/hicolor/512x512/apps/sh.ppy.Osu.svg
      - install -Dm644 sh.ppy.Osu.appdata.xml /app/share/appdata/sh.ppy.Osu.appdata.xml
      - install -Dm644 sh.ppy.Osu.desktop /app/share/applications/sh.ppy.Osu.desktop
      - install -Dm644 linux-discord-rpc.dll /app/discord-rpc.dll

    sources:
      - type: file
        path: sh.ppy.Osu.svg

      - type: file
        path: sh.ppy.Osu.appdata.xml

      - type: file
        path: sh.ppy.Osu.desktop
        
      - type: file
        url: https://github.com/goeo-/discord-rpc/releases/download/v3.2.0/linux-discord-rpc.dll
        sha256: 216bed4c3f79375a6389779b9087ed18d9dae95304362dd21bf9f406cf3e49eb
