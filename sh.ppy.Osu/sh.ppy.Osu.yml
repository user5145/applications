app-id: sh.ppy.Osu
branch: alfa

runtime: org.winepak.Platform/i386
runtime-version: 3.0
sdk: org.winepak.Sdk/i386

command: start

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  - --allow=multiarch
  - --device=all
  - --share=network
  - --env=WINEPREFIX=/var/data/win32
  - --env=WINEARCH=win32
  - --env=WINEDEBUG=-all
  - --env=PATH=/app/wine/bin:/app/bin:/usr/bin
  - --filesystem=home:ro
  - "--extra-data=osu!install.exe:a5682d6f8262f248595320b727bda5f11af593122ed1cb7229f299f0623dff0a:4188864:4188864:https://m1.ppy.sh/r/osu!install.exe"

build-options:
  cflags: -O2 -pipe -fstack-protector-strong -fno-plt -frecord-gcc-switches -D_FORTIFY_SOURCE=1 -msse -msse2 -msse3 -mssse3 -mfpmath=sse
  cxxflags: -O2 -pipe -fstack-protector-strong -fno-plt -frecord-gcc-switches -D_FORTIFY_SOURCE=1 -msse -msse2 -msse3 -mssse3 -mfpmath=sse
  ldflags: -fstack-protector-strong -Wl,-z,relro,-z,now
  prefix: "/app/wine"

modules:
- name: setup-wine
  buildsystem: simple
  build-commands:
  - mkdir -p /app/wine

- name: wine-win32
  config-opts:
  - --disable-win64
  - --disable-win16
  - --disable-tests
  - --with-x
  - --with-ldap
  - --with-netapi
  - --without-cups
  - --without-curses
  - --without-capi
  - --without-glu
  - --without-gphoto
  - --without-gsm
  - --without-hal
  - --without-opencl
  - --without-pcap
  - --without-udev
  cleanup:
  - /app/wine/app/wine/share/man
  - /app/wine/share/applications
  sources:
  - type: archive
    url: https://dl.winehq.org/wine/source/4.x/wine-4.6.tar.xz
    sha256: 329001f924d3f825121a1b28cae8e36515405f2a1d22bc266897d3d926b562da

- name: scripts
  buildsystem: simple
  build-commands:
  - install -d /app/bin
  - install start /app/bin
  - install installer /app/bin
  sources:
  - type: script
    dest-filename: installer
    commands:
    - mkdir -p /var/data/win32
    - wineboot
    -
    - # order user to wait
    - winetricks dotnet452 | tee /tmp/dotnet.log | zenity --progress --pulsate --auto-close --auto-kill --no-cancel --text="Installing .net. When asked about restart click whatever. Please ignore windows update service bullshit message and click continue"
    - winetricks gdiplus | tee /tmp/gdiplus.log | zenity --progress --pulsate --auto-close --auto-kill --no-cancel --text="Installing gdiplus."
    - winetricks cjkfonts | tee /tmp/cjkfonts.log | zenity --progress --pulsate --auto-close --auto-kill --no-cancel --text="Installing fonts. Osu should start automatically."
    -
    - install -Dm644 /app/discord-rpc.dll "${WINEPREFIX}/drive_c/users/$USER/Local Settings/Application Data/osu!/discord-rpc.dll"
    -
    - # use win8.1 for wintab api
    - wine reg add 'HKEY_CURRENT_USER\Software\Wine' /v Version /d win81 /f
    -
    - # osu installer complains about read only filesystem so we can copy it to /tmp
    - cp /app/extra/osu!install.exe /tmp
    - wine /tmp/osu!install.exe

  - type: script
    dest-filename: start
    commands:
    - # if osu doesn't exist then install
    - if [[ ! -e "${WINEPREFIX}/drive_c/users/$USER/Local Settings/Application Data/osu!/osu!.exe" ]] ; then
    - '    source /app/bin/installer'
    - '    if [[ $? != 0 ]] ; then'
    - '        echo "Installation failed, abort."'
    - '        exit 1'
    - '    fi'
    - else
    -      # if arguments exist then let wine handle them, otherwise just launch osu
    -      if [[ $# == 0 ]] ; then
    -           wine "C:/users/$USER/Local Settings/Application Data/osu!/osu!.exe"
    -      else
    -           wine start /ProgIDOpen osu! "$@"
    -      fi
    - fi

- name: fix
  buildsystem: simple
  build-commands:
  - install -Dm644 linux-discord-rpc.dll /app/discord-rpc.dll
  sources:
  - type: file
    url: https://github.com/goeo-/discord-rpc/releases/download/v3.2.0/linux-discord-rpc.dll
    sha256: 216bed4c3f79375a6389779b9087ed18d9dae95304362dd21bf9f406cf3e49eb

- name: resources
  buildsystem: simple
  build-commands:
  - install -Dm644 sh.ppy.Osu.svg /app/share/icons/hicolor/512x512/apps/sh.ppy.Osu.svg
  - install -Dm644 sh.ppy.Osu.appdata.xml /app/share/appdata/sh.ppy.Osu.appdata.xml
  - install -Dm644 sh.ppy.Osu.desktop /app/share/applications/sh.ppy.Osu.desktop
  sources:
  - type: file
    path: sh.ppy.Osu.svg
  - type: file
    path: sh.ppy.Osu.appdata.xml
  - type: file
    path: sh.ppy.Osu.desktop
