app-id: org.openarl.PathofBuilding
branch: stable

runtime: org.winepak.Platform/i386
runtime-version: 3.0
sdk: org.winepak.Sdk/i386

command: start.sh

tags:
- proprietary

finish-args:
- --socket=x11
- --share=ipc
- --socket=pulseaudio
- --allow=multiarch
- --device=all
- --share=network
- --env=WINEPREFIX=/var/data/win32
- --env=WINEARCH=win32
- --env=WINEDEBUG=-all
- --filesystem=/run/media
- --filesystem=/mnt
- --filesystem=home
- "--extra-data=PathOfBuilding_Setup.exe:97645236b8f94daa9fdaae126e53428c93b3d55c4ae6d2878a5beaa792123e13:23365310:23365310:https://github.com/Openarl/PathOfBuilding/releases/download/v1.4.137/PathOfBuilding-Setup-1.4.137.exe"

build-options:
  cflags: -O2 -pipe -fstack-protector-strong -fno-plt -frecord-gcc-switches -D_FORTIFY_SOURCE=1 -msse -msse2 -msse3 -mssse3 -mfpmath=sse
  cxxflags: -O2 -pipe -fstack-protector-strong -fno-plt -frecord-gcc-switches -D_FORTIFY_SOURCE=1 -msse -msse2 -msse3 -mssse3 -mfpmath=sse
  ldflags: -fstack-protector-strong -Wl,-z,relro,-z,now
  prefix: "/app"
  libdir: "/app/lib"

modules:
- "flatpak_wine_infrastructure_script/wine_infrastructure.yml"

- name: wine-win32
  config-opts:
  - --disable-win64
  - --disable-win16
  - --disable-tests
  - --with-x
  - --with-ldap
  - --with-netapi
  - --without-cups
  - --without-curses
  - --without-capi
  - --without-glu
  - --without-gphoto
  - --without-gsm
  - --without-hal
  - --without-opencl
  - --without-pcap
  - --without-udev
  cleanup:
  - /app/wine/app/wine/share/man
  - /app/wine/share/applications
  sources:
  - type: archive
    url: https://dl.winehq.org/wine/source/4.0/wine-4.0.tar.xz
    sha256: 6736cdee95b2b8bb021ec0c19497ed8cad5ae2c8bfdb7ab5dc687ff92a480d4d

- name: setup
  buildsystem: simple
  build-commands:
  - mkdir -p /app/bin
  - install -Dm555 start.sh /app/bin
  - install -Dm555 installer.sh /app/bin
  - install -Dm555 check_compat.sh /app/bin

  sources:
  - type: script
    dest-filename: installer.sh
    commands:
    - mkdir -p $WINEPREFIX
    - wineboot
    -
    - wine /app/extra/PathOfBuilding_Setup.exe
    - exit 0

  - type: script
    dest-filename: start.sh
    commands:
    - #install
    - source setup_infrastructure.sh -r "check_compat.sh" "${WINEPREFIX}/drive_c/Program Files/Path of Building/Path of Building.exe" "installer.sh"
    -
    - echo "launching ${FLATPAK_ID}"
    - wine "C:/Program Files/Path of Building/Path of Building.exe" "$@"

  - type: script
    dest-filename: check_compat.sh
    commands:
    - grep 'ssse3' /proc/cpuinfo > /dev/null
    - if [[ $? != 0 ]]; then
    -   zenity --question --title="${FLATPAK_ID} Warning" --text "Your cpu lacks support thus wrapper will not work. If you think this is a bug click continue" --ok-label="Continue" --cancel-label="Cancel"
    -   if [[ "$?" != 0 ]]; then
    -       exit
    -   fi
    - fi

- name: resources
  buildsystem: simple
  build-commands:
  - install -Dm644 org.openarl.PathofBuilding.png /app/share/icons/hicolor/256x256/apps/org.openarl.PathofBuilding.png
  - install -Dm644 org.openarl.PathofBuilding.appdata.xml /app/share/appdata/org.openarl.PathofBuilding.appdata.xml
  - install -Dm644 org.openarl.PathofBuilding.desktop /app/share/applications/org.openarl.PathofBuilding.desktop
  sources:
  - type: file
    path: org.openarl.PathofBuilding.appdata.xml
  - type: file
    path: org.openarl.PathofBuilding.desktop
  - type: file
    path: org.openarl.PathofBuilding.png
